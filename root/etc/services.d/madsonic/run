#!/usr/bin/with-contenv sh

APP_UID=${APP_UID:-666}
APP_GID=${APP_GID:-666}
APP_USER=${APP_USER:-appuser}

KEEP_TRANSCODE=${KEEP_TRANSCODE:-"false"}

CONFIG_PATH=${HOME_PATH:-"/config"}
CONTEXT=${CONTEXT:-"/"}
MEDIA_PATH=${MEDIA_PATH:-"/media"}
PODCAST_PATH=${PODCAST_PATH:-"/podcast"}
PLAYLIST_PATH=${PLAYLIST_PATH:-"/playlist"}
TRANSCODE_PATH=${TRANSCODE_PATH:-"/app/transcode"}

MADSONIC_HOME=$CONFIG_PATH
MADSONIC_HOST=0.0.0.0
MADSONIC_PORT=4040
MADSONIC_HTTPS_PORT=0
MADSONIC_CONTEXT_PATH=$CONTEXT
MADSONIC_INIT_MEMORY=256
MADSONIC_MAX_MEMORY=512
MADSONIC_DEFAULT_MUSIC_FOLDER=$MEDIA_PATH
MADSONIC_DEFAULT_UPLOAD_FOLDER=/config/media/incoming
MADSONIC_DEFAULT_PODCAST_FOLDER=$PODCAST_PATH
MADSONIC_DEFAULT_PLAYLIST_IMPORT_FOLDER="$PLAYLIST_PATH/import"
MADSONIC_DEFAULT_PLAYLIST_EXPORT_FOLDER="$PLAYLIST_PATH/export"
MADSONIC_DEFAULT_PLAYLIST_BACKUP_FOLDER="$PLAYLIST_PATH/backup"
MADSONIC_DEFAULT_TRANSCODE_FOLDER=$TRANSCODE_PATH
MADSONIC_DEFAULT_TIMEZONE=
MADSONIC_PIDFILE=
MADSONIC_UPDATE=true
MADSONIC_GZIP=
MADSONIC_DB=
quiet=0

mkdir -p $MADSONIC_DEFAULT_UPLOAD_FOLDER
mkdir -p $MADSONIC_DEFAULT_PODCAST_FOLDER
mkdir -p $MADSONIC_DEFAULT_PLAYLIST_IMPORT_FOLDER
mkdir -p $MADSONIC_DEFAULT_PLAYLIST_EXPORT_FOLDER
mkdir -p $MADSONIC_DEFAULT_PLAYLIST_BACKUP_FOLDER
mkdir -p $MADSONIC_DEFAULT_TRANSCODE_FOLDER

# Use JAVA_HOME if set, otherwise assume java is in the path.
JAVA=java
if [ -e "${JAVA_HOME}" ]
    then
    JAVA=${JAVA_HOME}/bin/java
fi

# Use system install of ffmpeg for transcoding
if [ "$KEEP_TRANSCODE" == "false" ]; then
  [ ! -d $MADSONIC_DEFAULT_TRANSCODE_FOLDER ] || rm -r $MADSONIC_DEFAULT_TRANSCODE_FOLDER
  mkdir -p $MADSONIC_DEFAULT_TRANSCODE_FOLDER
  ln -s "$(command -v ffmpeg)" $MADSONIC_DEFAULT_TRANSCODE_FOLDER/ffmpeg
  ln -s "$(command -v lame)" $MADSONIC_DEFAULT_TRANSCODE_FOLDER/lame
fi

# Create Madsonic home directory.
mkdir -p ${MADSONIC_HOME}
LOG=${MADSONIC_HOME}/madsonic_sh.log
rm -f ${LOG}

if [ -e "${APP_PATH}" ]
    then
    cd ${APP_PATH}
fi

s6-setuidgid ${APP_USER} ${JAVA} -Xms${MADSONIC_INIT_MEMORY}m -Xmx${MADSONIC_MAX_MEMORY}m \
  -Dmadsonic.home=${MADSONIC_HOME} \
  -Dmadsonic.host=${MADSONIC_HOST} \
  -Dmadsonic.port=${MADSONIC_PORT} \
  -Dmadsonic.httpsPort=${MADSONIC_HTTPS_PORT} \
  -Dmadsonic.contextPath=${MADSONIC_CONTEXT_PATH} \
  -Dmadsonic.defaultMusicFolder=${MADSONIC_DEFAULT_MUSIC_FOLDER} \
  -Dmadsonic.defaultUploadFolder=${MADSONIC_DEFAULT_UPLOAD_FOLDER} \
  -Dmadsonic.defaultPodcastFolder=${MADSONIC_DEFAULT_PODCAST_FOLDER} \
  -Dmadsonic.defaultPlaylistImportFolder=${MADSONIC_DEFAULT_PLAYLIST_IMPORT_FOLDER} \
  -Dmadsonic.defaultPlaylistExportFolder=${MADSONIC_DEFAULT_PLAYLIST_EXPORT_FOLDER} \
  -Dmadsonic.defaultPlaylistBackupFolder=${MADSONIC_DEFAULT_PLAYLIST_BACKUP_FOLDER} \
  -Dmadsonic.defaultTranscodeFolder=${MADSONIC_DEFAULT_TRANSCODE_FOLDER} \
  -Duser.timezone=${MADSONIC_DEFAULT_TIMEZONE} \
  -Dmadsonic.update=${MADSONIC_UPDATE} \
  -Dmadsonic.gzip=${MADSONIC_GZIP} \
  -Dmadsonic.db="${MADSONIC_DB}" \
  -Djava.awt.headless=true \
  -jar madsonic-booter.jar >> ${LOG} 2>&1 
